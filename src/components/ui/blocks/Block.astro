---
import Header from "./header/Header.svelte";
import { CharacterCard } from "../cards/character";
import { WeaponCard } from "../cards/weapon";
import directus from "$services/directus";
import { readItem } from "@directus/sdk";
const { item, container = false } = Astro.props;
const { tag: Tag, event, game, id, grid, style, events, ...rest } = item;
const base = item.base ? item.base : rest;

const list = item.classlist
  ? item.classlist
  : ["grid", "grid-rows-subgrid", "grid-cols-subgrid"];

const p_char = await directus.request(
  readItem("characters", game.id, {
    fields: ["*", { splash_art: ["*"] }, { splash_pad: ["*"] }],
  })
);
const p_weap = await directus.request(
  readItem("weapons", game.id, {
    fields: ["*"],
  })
);

const junction: any = container ? "block_container_blocks" : "layouts_blocks";

let blocks = (
  await Promise.all(
    item.blocks.map(
      async (bid: any) =>
        await directus.request(readItem(junction, bid, { fields: ["*.*"] }))
    )
  )
).filter((block: any) => {
  if (block.item.opt) {
    switch (block.collection) {
      case "block_character": {
        const char_list = event.featured_characters.filter(
          (x: any) => x.characters_id.rarity == block.item.rarity
        );
        if (char_list.length > block.item.index) {
          return block;
        }
        break;
      }
      case "block_weapon": {
        const char_list = event.featured_characters.filter(
          (x: any) => x.characters_id.rarity == 5
        );
        if (block.item.signature && char_list.length > block.item.index) {
          return block;
        } else if (
          !block.item.signature &&
          event.featured_weapons.length > block.item.index
        ) {
          return block;
        }
        break;
      }
      default: {
        return block;
      }
    }
  } else {
    return block;
  }
});

list.push(
  "empty:hidden",
  "only-of-type:grid",
  "only-of-type:grid-rows-7",
  "group"
);
---

{
  blocks.length > 0 && (
    <Tag class:list={list} style={item.style}>
      {blocks != undefined &&
        blocks.map((block: any) => {
          let item = block.item;
          item.event = event;
          item.game = game;
          item.base = base;

          switch (block.collection) {
            case "block_container": {
              const container = true;
              return <Astro.self {item} {container} />;
            }
            case "block_header": {
              return <Header {item} client:load />;
            }
            case "block_character": {
              const char_list = event.featured_characters.filter(
                (x: any) => x.characters_id.rarity == item.rarity
              );
              item.classlist.push("basis-2/3", "group-only-of-type:row-span-6");

              if (char_list && char_list.length > item.index) {
                const { characters_id, ...rest } = char_list[item.index];
                const character = structuredClone(characters_id);
                character.spec = rest.spec;
                return (
                  <div class:list={item.classlist}>
                    <CharacterCard {character} {item} />
                  </div>
                );
              } else if (!item.opt) {
                let character: { [key: string]: any } = structuredClone(p_char);
                character.spec = false;
                character.rarity = item.rarity;
                character.splash_art =
                  item.rarity == 5 ? undefined : character.splash_art;
                character.splash_pad =
                  item.rarity == 5 ? undefined : character.splash_pad;

                return (
                  <div class:list={item.classlist}>
                    <CharacterCard {character} {item} />
                  </div>
                );
              }
              break;
            }
            case "block_weapon": {
              const char_list = event.featured_characters.filter(
                (x: any) => x.characters_id.rarity == 5
              );
              item.classlist.push("basis-1/3", "group-only-of-type:row-span-1");

              if (item.signature && char_list.length > item.index) {
                const { characters_id, ...rest } =
                  event.featured_characters[item.index];
                const character = structuredClone(characters_id);
                const weapon = character.signature;
                return <WeaponCard {weapon} {item} />;
              } else if (
                !item.signature &&
                event.featured_weapons.length > item.index
              ) {
                const { weapons_id } = event.featured_weapons[item.index];
                const weapon = structuredClone(weapons_id);
                return <WeaponCard {weapon} {item} />;
              } else if (!item.opt) {
                let weapon: { [key: string]: any } = structuredClone(p_weap);
                weapon.rarity = item.signature ? 5 : 4;
                return <WeaponCard {weapon} {item} />;
              }
              break;
            }
          }
        })}
    </Tag>
  )
}
