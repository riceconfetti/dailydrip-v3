---
import directus from "$services/directus";
import { readItem } from "@directus/sdk";
import Layout from "$layouts/Layout.astro";
import BannerCard from "$components/card/BannerCard.astro";

export const prerender = false;

const { gameId, charId, eventsId } = Astro.params;

if ([gameId, charId, eventsId].includes(undefined)) {
  return Astro.rewrite("/404");
}

let juncEvent = await directus.request(
  readItem("events_characters", eventsId!),
);
let game = await directus.request(readItem("games", gameId!));
let character = await directus.request(
  readItem("characters", charId!, {
    fields: [
      "id",
      "rarity",
      "game",
      "bannerName",
      "name",
      "focalPoint",
      "crop",
      "colors",
      "card_edits",
    ],
  }),
);
let event: any = await directus.request(
  readItem("events", juncEvent.events_id, {
    fields: ["startDate", "endDate", "phase"],
  }),
);
let { phase, ...rest } = event;
phase = await directus.request(readItem("phases", event.phase));
let bannerEvent = { phase };
Object.assign(bannerEvent, character, rest);
const title =
  "Daily Drip | " +
  game.name +
  " | " +
  character.name +
  " | " +
  event.startDate;
---

<Layout {title}>
  <BannerCard {bannerEvent} />
</Layout>
